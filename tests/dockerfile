## Test DB Container - Validates Managed Identity SQL permissions
## Usage: Build and deploy as a Container App with the user-assigned identity attached
## Required env vars (in Container App):
##   SQL_SERVER_NAME (short server name WITHOUT .database.windows.net or full FQDN) 
##   SQL_DATABASE_NAME (default todo)
## Optional: DB_TABLE (default dbo.todo), LOG_VERBOSITY (Normal|Debug)

FROM mcr.microsoft.com/powershell:lts-debian-11 AS base
ENV DEBIAN_FRONTEND=noninteractive \
	POWERSHELL_TELEMETRY_OPTOUT=1 \
	SQL_DATABASE_NAME=todo \
	LOG_VERBOSITY=Normal

WORKDIR /app

# Install prerequisites: curl, ca-certificates, less (for any paging), and required PowerShell modules
RUN apt-get update \
	&& apt-get install -y --no-install-recommends curl ca-certificates jq \
	&& pwsh -NoLogo -NoProfile -Command "Set-PSRepository -Name PSGallery -InstallationPolicy Trusted; Install-PackageProvider -Name NuGet -Force; Install-Module Az.Accounts -Scope AllUsers -Force -Confirm:\$false; Install-Module Az.Sql -Scope AllUsers -Force -Confirm:\$false; Write-Host 'Modules installed'" \
	&& apt-get clean && rm -rf /var/lib/apt/lists/*

# Copy test script
COPY test-db.ps1 /app/test-db.ps1

# Default command runs the script then sleeps shortly so logs can be gathered
ENTRYPOINT ["pwsh","-NoLogo","-NoProfile","-File","/app/test-db.ps1"]
