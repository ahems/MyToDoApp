FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /config

RUN dotnet new tool-manifest

RUN dotnet tool install Microsoft.DataApiBuilder

# Copy the pre-configured dab-config.json file
COPY dab-config.json .

FROM mcr.microsoft.com/azure-databases/data-api-builder

COPY --from=build /config /App

# Add startup wrapper that waits for Managed Identity token availability
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Optional tuning via env vars
# MI_RESOURCE: resource URL for token acquisition (default: https://database.windows.net)
# MI_INITIAL_DELAY_SECONDS, MI_PERIOD_SECONDS, MI_FAILURE_THRESHOLD to control wait behavior
ENV MI_RESOURCE="https://database.windows.net" \
	MI_INITIAL_DELAY_SECONDS="0" \
	MI_PERIOD_SECONDS="1" \
	MI_FAILURE_THRESHOLD="60"

ENTRYPOINT ["/entrypoint.sh"]