FROM mcr.microsoft.com/dotnet/sdk:8.0 AS build

WORKDIR /config

RUN dotnet new tool-manifest

RUN dotnet tool install Microsoft.DataApiBuilder

RUN dotnet tool run dab -- init --auth.provider "AzureAD" --auth.audience "@env('API_APP_ID_URI')" --auth.issuer "https://login.microsoftonline.com/@env('TENANT_ID')/v2.0" --database-type "mssql" --connection-string "@env('DATABASE_CONNECTION_STRING')" \
	&& python3 - <<'PY'
import json
from pathlib import Path

config_path = Path('dab-config.json')
cfg = json.loads(config_path.read_text())

auth = cfg.setdefault('authentication', {})
auth['provider'] = 'AzureAD'
auth['audience'] = "@env('API_APP_ID_URI')"
auth['issuer'] = "https://login.microsoftonline.com/@env('TENANT_ID')/v2.0"

client_ids = set(auth.get('clientApplicationIds', []))
client_ids.add("@env('CLIENT_ID')")
auth['clientApplicationIds'] = sorted(client_ids)

config_path.write_text(json.dumps(cfg, indent=2) + '\n')
PY

RUN dotnet tool run dab -- add todo --source "dbo.ToDo" --permissions "authenticated:*";

# NOTE: Cannot pass @env('VAR') directly on the command line because the .NET host treats
# arguments starting with @ as response file references. We add a dummy value then
# replace it in the generated dab-config.json with the @env(...) placeholder so that
# runtime substitution still happens inside the JSON config.
RUN dotnet tool run dab add-telemetry --app-insights-enabled true --app-insights-conn-string "DUMMY_AI_CONN_STRING" \
	&& sed -i "s/\"connection-string\": \"DUMMY_AI_CONN_STRING\"/\"connection-string\": \"@env('APPLICATIONINSIGHTS_CONNECTION_STRING')\"/" dab-config.json

FROM mcr.microsoft.com/azure-databases/data-api-builder

COPY --from=build /config /App

# Add startup wrapper that waits for Managed Identity token availability
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

# Optional tuning via env vars
# MI_RESOURCE: resource URL for token acquisition (default: https://database.windows.net)
# MI_INITIAL_DELAY_SECONDS, MI_PERIOD_SECONDS, MI_FAILURE_THRESHOLD to control wait behavior
ENV MI_RESOURCE="https://database.windows.net" \
	MI_INITIAL_DELAY_SECONDS="0" \
	MI_PERIOD_SECONDS="1" \
	MI_FAILURE_THRESHOLD="60"

ENTRYPOINT ["/entrypoint.sh"]